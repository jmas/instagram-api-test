<!doctype html>
<html>
<head>
   <title>Instagram API test</title>

   <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css" />
</head>
<body>

<main class="container">

<h1>Instagram API test</h1>

<p>
  <a href="#" id="login">Login via Instagram</a>
</p>

<h2>Access token</h2>

<textarea id="queryAccessToken" rows="5" cols="100" placeholder="Code for Query Access Token" onclick="this.select()"></textarea>

<textarea id="accessToken" rows="5" cols="100" placeholder="Put Access Token here"></textarea>

<h2>Profile</h2>

<p>
  <button type="button" id="readProfile">Read Profile</button>
</p>

<textarea id="profile" rows="5" cols="100"></textarea>

<h2>Media</h2>

<p>
  <button type="button" id="readMedia">Read Media</button>
</p>

<table id="media">
  <thead>
    <tr>
      <th>id</th>
      <th>media_type</th>
      <th>media_url</th>
      <th>username</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<p>
  <button type="button" id="next">Next</button>
</p>

</div>

<script>
function getRedirectUrl() {
  return `${location.protocol}//${location.host}${location.pathname}`;
}

function setLogin() {
  document.getElementById('login').href = `https://api.instagram.com/oauth/authorize?client_id=${getClientId()}&redirect_uri=${getRedirectUrl()}&scope=user_profile,user_media&response_type=code`;
}

function getClientId() {
  return localStorage.getItem('clientId');
}

function getClientSecret() {
  return localStorage.getItem('clientSecret');
}

function getAccessToken() {
  return document.getElementById('accessToken').value;
}

function getCode() {
  return new URLSearchParams(location.search).get('code');
}

function setProfile(value) {
  document.getElementById('profile').value = JSON.stringify(value, null, 2);
}

function setQueryAccessToken() {
  document.getElementById('queryAccessToken').value = `curl -X POST https://api.instagram.com/oauth/access_token -F client_id=${getClientId()} -F client_secret=${getClientSecret()} -F grant_type=authorization_code -F redirect_uri=https://jmas.github.io/instagram-api-test/ -F code=${getCode()}`;
}

function setMedia({ data, paging }) {
  const result = data.map(({ id, media_type, media_url, username, timestamp }) => {
    return `<tr><td>${id}</td><td>${media_type}</td><td><a href="${media_url}" target="_blank"><img src="${media_url}" width="100" /></a></td><td>${username}</td><td>${timestamp}</td></tr>`;
  }).join('');

  document.getElementById('media').querySelector('tbody').innerHTML = result;
  document.getElementById('next').dataset.url = `${paging.next}`;
}

function readProfile() {
  const accessToken = getAccessToken();
  
fetch(`https://graph.instagram.com/v16.0/me?fields=id,account_type,media_count,username&access_token=${accessToken}`).then(response => response.json()).then(data => {
    console.log({ data });

    // populate profile
    setProfile(data);
  });
}

function readMedia() {
  const accessToken = getAccessToken();
  
  fetch(`https://graph.instagram.com/me/media?fields=id,media_type,media_url,username,timestamp&access_token=${accessToken}`).then(response => response.json()).then(data => {
    console.log({ data });

    // populate media
    setMedia(data);
  });
}

function next(event) {
  fetch(event.currentTarget.dataset.url).then(response => response.json()).then(data => {
    console.log({ data });

    setMedia(data);
  })
}

document.getElementById('readProfile').onclick = readProfile;
document.getElementById('readMedia').onclick = readMedia;
document.getElementById('next').onclick = next;

setLogin();
setQueryAccessToken();
</script>

</body>
</html>
